    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Financial Independence Calculator</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 20px;
                background-color: #f5f5f5;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                border-radius: 10px;
                padding: 30px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            h1 {
                text-align: center;
                color: #333;
                margin-bottom: 30px;
            }

            .input-section {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .input-group {
                display: flex;
                flex-direction: column;
            }

            label {
                font-weight: bold;
                margin-bottom: 5px;
                color: #555;
            }

            input {
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 16px;
            }

            .calculate-btn {
                background-color: #4CAF50;
                color: white;
                padding: 15px 30px;
                border: none;
                border-radius: 5px;
                font-size: 18px;
                cursor: pointer;
                margin: 20px auto;
                display: block;
            }

            .calculate-btn:hover {
                background-color: #45a049;
            }

            .results-section {
                margin-top: 30px;
            }

            .key-results {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .result-card {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 8px;
                text-align: center;
                border-left: 4px solid #4CAF50;
            }

            .result-card h3 {
                margin: 0 0 10px 0;
                color: #333;
            }

            .result-card .value {
                font-size: 24px;
                font-weight: bold;
                color: #4CAF50;
            }

            .chart-container {
                margin: 30px 0;
                height: 400px;
                position: relative;
            }

            .table-container {
                overflow-x: auto;
                margin-top: 30px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 14px;
            }

            th, td {
                padding: 12px;
                text-align: right;
                border-bottom: 1px solid #ddd;
            }

            th {
                background-color: #f8f9fa;
                font-weight: bold;
                color: #333;
            }

            .status-building {
                color: #ff6b6b;
                font-weight: bold;
            }

            .status-fi {
                color: #4CAF50;
                font-weight: bold;
            }

            .fi-row {
                background-color: #e8f5e8;
            }

            #results {
                display: none;
            }

            .debt-section {
                margin: 30px 0;
                padding: 20px;
                background: #f8f9fa;
                border-radius: 10px;
            }

            .debt-section h2 {
                text-align: center;
                color: #333;
                margin-bottom: 20px;
            }

            .debt-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 20px;
            }

            .debt-item {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .debt-item h3 {
                margin: 0 0 15px 0;
                color: #333;
                text-align: center;
                font-size: 18px;
                border-bottom: 2px solid #4CAF50;
                padding-bottom: 10px;
            }

            .debt-inputs {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .debt-inputs .input-group {
                margin-bottom: 0;
            }

            .debt-inputs label {
                font-size: 14px;
            }

            .debt-inputs input,
            .debt-inputs select {
                padding: 8px;
                font-size: 14px;
                border: 1px solid #ddd;
                border-radius: 5px;
            }

            .scenario-controls {
                margin: 30px 0;
                text-align: center;
            }

            .scenario-controls .input-group {
                max-width: 300px;
                margin: 0 auto 20px auto;
            }

            .control-buttons {
                display: flex;
                gap: 20px;
                justify-content: center;
                flex-wrap: wrap;
            }

            .clear-btn {
                background-color: #f44336;
                color: white;
                padding: 15px 30px;
                border: none;
                border-radius: 5px;
                font-size: 18px;
                cursor: pointer;
            }

            .clear-btn:hover {
                background-color: #d32f2f;
            }

            .scenario-result {
                margin-bottom: 10px;
                padding: 8px;
                border-radius: 4px;
            }

            .scenario-1 { background-color: rgba(76, 175, 80, 0.1); border-left: 4px solid
    #4CAF50; }
            .scenario-2 { background-color: rgba(33, 150, 243, 0.1); border-left: 4px solid
    #2196F3; }
            .scenario-3 { background-color: rgba(255, 152, 0, 0.1); border-left: 4px solid
    #FF9800; }

            .disclaimer {
                max-width: 1200px;
                margin: 40px auto;
                padding: 30px;
                background-color: #f8f9fa;
                border-radius: 10px;
                border: 1px solid #dee2e6;
            }

            .disclaimer h3 {
                color: #333;
                margin-top: 0;
                margin-bottom: 15px;
                font-size: 18px;
            }

            .disclaimer p {
                color: #666;
                font-size: 14px;
                line-height: 1.6;
                margin: 0;
                text-align: justify;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Financial Independence Calculator</h1>

            <div class="input-section">
                <div class="input-group">
                    <label for="startingCapital">Starting Capital ($)</label>
                    <input type="number" id="startingCapital" value="100000" step="1000">
                </div>

                <div class="input-group">
                    <label for="currentAge">Current Age</label>
                    <input type="number" id="currentAge" value="45" step="1">
                </div>

                <div class="input-group">
                    <label for="lifeExpectancy">Life Expectancy</label>
                    <input type="number" id="lifeExpectancy" value="90" step="1">
                </div>

                <div class="input-group">
                    <label for="activeUntilAge">Active Until Age</label>
                    <input type="number" id="activeUntilAge" value="70" step="1">
                </div>

                <div class="input-group">
                    <label for="activeSpending">Annual Active Spending ($)</label>
                    <input type="number" id="activeSpending" value="60000" step="1000">
                </div>

                <div class="input-group">
                    <label for="inactiveSpending">Annual Inactive Spending ($)</label>
                    <input type="number" id="inactiveSpending" value="45000" step="1000">
                </div>

                <div class="input-group">
                    <label for="rateOfReturn">Rate of Return (%)</label>
                    <input type="number" id="rateOfReturn" value="7" step="0.1">
                </div>

                <div class="input-group">
                    <label for="annualContributions">Annual Contributions ($)</label>
                    <input type="number" id="annualContributions" value="45000" step="1000">
                </div>

                <div class="input-group">
                    <label for="inflationRate">Inflation Rate (%)</label>
                    <input type="number" id="inflationRate" value="2.1" step="0.1">
                </div>

                <div class="input-group">
                    <label for="withdrawalRate">Withdrawal Rate (%)</label>
                    <input type="number" id="withdrawalRate" value="4" step="0.1">
                </div>
            </div>

            <div class="debt-section">
                <h2>Debt Tracking</h2>
                <div class="debt-grid">
                    <div class="debt-item">
                        <h3>Mortgage</h3>
                        <div class="debt-inputs">
                            <div class="input-group">
                                <label for="mortgageBalance">Outstanding Balance ($)</label>
                                <input type="number" id="mortgageBalance" value="0" 
    step="1000">
                            </div>
                            <div class="input-group">
                                <label for="mortgageRate">Interest Rate (%)</label>
                                <input type="number" id="mortgageRate" value="0" step="0.1">
                            </div>
                            <div class="input-group">
                                <label for="mortgagePayment">Total Monthly Payment ($)</label>
                                <input type="number" id="mortgagePayment" value="0" step="50">
                            </div>
                            <div class="input-group">
                                <label for="mortgageExtraPayment">Additional Monthly Principal
    Payment ($)</label>
                                <input type="number" id="mortgageExtraPayment" value="0" 
    step="25">
                            </div>
                            <div class="input-group">
                                <label for="mortgageAffectContributions">Affect Annual
    Contributions</label>
                                <select id="mortgageAffectContributions">
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="debt-item">
                        <h3>Vehicle Loan</h3>
                        <div class="debt-inputs">
                            <div class="input-group">
                                <label for="vehicleBalance">Outstanding Balance ($)</label>
                                <input type="number" id="vehicleBalance" value="0" step="1000">
                            </div>
                            <div class="input-group">
                                <label for="vehicleRate">Interest Rate (%)</label>
                                <input type="number" id="vehicleRate" value="0" step="0.1">
                            </div>
                            <div class="input-group">
                                <label for="vehiclePayment">Total Monthly Payment ($)</label>
                                <input type="number" id="vehiclePayment" value="0" step="50">
                            </div>
                            <div class="input-group">
                                <label for="vehicleExtraPayment">Additional Monthly Principal
    Payment ($)</label>
                                <input type="number" id="vehicleExtraPayment" value="0" 
    step="25">
                            </div>
                            <div class="input-group">
                                <label for="vehicleAffectContributions">Affect Annual
    Contributions</label>
                                <select id="vehicleAffectContributions">
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="debt-item">
                        <h3>Other</h3>
                        <div class="debt-inputs">
                            <div class="input-group">
                                <label for="otherBalance">Outstanding Balance ($)</label>
                                <input type="number" id="otherBalance" value="0" step="1000">
                            </div>
                            <div class="input-group">
                                <label for="otherRate">Interest Rate (%)</label>
                                <input type="number" id="otherRate" value="0" step="0.1">
                            </div>
                            <div class="input-group">
                                <label for="otherPayment">Total Monthly Payment ($)</label>
                                <input type="number" id="otherPayment" value="0" step="50">
                            </div>
                            <div class="input-group">
                                <label for="otherExtraPayment">Additional Monthly Principal
    Payment ($)</label>
                                <input type="number" id="otherExtraPayment" value="0" 
    step="25">
                            </div>
                            <div class="input-group">
                                <label for="otherAffectContributions">Affect Annual
    Contributions</label>
                                <select id="otherAffectContributions">
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="scenario-controls">
                <div class="input-group">
                    <label for="scenarioName">Scenario Name</label>
                    <input type="text" id="scenarioName" placeholder="Enter scenario name..." 
    maxlength="30">
                </div>
                <div class="control-buttons">
                    <button class="calculate-btn" onclick="calculateFI()">Calculate Financial
    Independence</button>
                    <button class="clear-btn" onclick="clearScenarios()">Clear
    Scenarios</button>
                </div>
            </div>

            <div id="results" class="results-section">
                <div class="key-results">
                    <div class="result-card">
                        <h3>Financial Independence Year</h3>
                        <div class="value" id="fiYear">-</div>
                    </div>
                    <div class="result-card">
                        <h3>Final Portfolio Value</h3>
                        <div class="value" id="finalValue">-</div>
                    </div>
                    <div class="result-card">
                        <h3>Monthly Savings Required</h3>
                        <div class="value" id="monthlySavings">-</div>
                    </div>
                </div>

                <h3>Portfolio Value Over Time</h3>
                <div class="chart-container">
                    <canvas id="portfolioChart"></canvas>
                </div>

                <h3>Annual Spending vs Withdrawal Capacity</h3>
                <div class="chart-container">
                    <canvas id="spendingChart"></canvas>
                </div>

                <div id="debtChartSection" style="display: none;">
                    <h3>Remaining Debt Balances</h3>
                    <div class="chart-container">
                        <canvas id="debtChart"></canvas>
                    </div>
                </div>

                <div class="table-container">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Age</th>
                                <th>Portfolio Value</th>
                                <th>Annual Spending</th>
                                <th>Withdrawal Capacity</th>
                                <th>Net Contributions</th>
                                <th>Remaining Debt</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="disclaimer">
            <h3>Disclaimer</h3>
            <p>This material is provided for general informational purposes only and does not
    constitute financial, investment, tax, legal or accounting advice, it should not be relied
    upon in that regard or be considered predictive of any future market performance, nor does
    it constitute an offer or solicitation to buy or sell any securities referred to.
    Individual circumstances and current events are critical to sound investment planning;
    anyone wishing to act on this material should consult with their advisor. Before making any
     investment decisions, we encourage you to consider these and other factors carefully. Past
     performance may not be repeated and is not indicative of future results.</p>
        </div>

        <script>
            let portfolioChartInstance = null;
            let spendingChartInstance = null;
            let debtChartInstance = null;

            let scenarios = [];
            const scenarioColors = ['#4CAF50', '#2196F3', '#FF9800'];

            function formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
            }

            function calculateMonthsRemaining(balance, rate, payment, extraPayment = 0) {
                if (balance <= 0 || payment <= 0) return 0;

                const totalPayment = payment + extraPayment;

                if (rate <= 0) return Math.ceil(balance / totalPayment);

                const monthlyRate = rate / 12;
                const monthlyInterest = balance * monthlyRate;

                if (totalPayment <= monthlyInterest) return Infinity; // Payment doesn't cover 
    interest

                return Math.ceil(-Math.log(1 - (balance * monthlyRate) / totalPayment) /
    Math.log(1 + monthlyRate));
            }

            function calculateFI() {
                if (scenarios.length >= 3) {
                    alert('Maximum of 3 scenarios allowed. Please clear scenarios to add 
    more.');
                    return;
                }

                let scenarioName = document.getElementById('scenarioName').value.trim();
                if (!scenarioName) {
                    scenarioName = `Scenario ${scenarios.length + 1}`;
                }

                const inputs = {
                    startingCapital:
    parseFloat(document.getElementById('startingCapital').value),
                    currentAge: parseInt(document.getElementById('currentAge').value),
                    lifeExpectancy: parseInt(document.getElementById('lifeExpectancy').value),
                    activeUntilAge: parseInt(document.getElementById('activeUntilAge').value),
                    activeSpending:
    parseFloat(document.getElementById('activeSpending').value),
                    inactiveSpending:
    parseFloat(document.getElementById('inactiveSpending').value),
                    rateOfReturn: parseFloat(document.getElementById('rateOfReturn').value) /
    100,
                    annualContributions:
    parseFloat(document.getElementById('annualContributions').value),
                    inflationRate: parseFloat(document.getElementById('inflationRate').value) /
     100,
                    withdrawalRate: parseFloat(document.getElementById('withdrawalRate').value)
     / 100,
                    debts: {
                        mortgage: {
                            balance:
    parseFloat(document.getElementById('mortgageBalance').value),
                            rate: parseFloat(document.getElementById('mortgageRate').value) /
    100,
                            payment:
    parseFloat(document.getElementById('mortgagePayment').value),
                            extraPayment:
    parseFloat(document.getElementById('mortgageExtraPayment').value),
                            affectContributions:
    document.getElementById('mortgageAffectContributions').value === 'yes'
                        },
                        vehicle: {
                            balance:
    parseFloat(document.getElementById('vehicleBalance').value),
                            rate: parseFloat(document.getElementById('vehicleRate').value) /
    100,
                            payment:
    parseFloat(document.getElementById('vehiclePayment').value),
                            extraPayment:
    parseFloat(document.getElementById('vehicleExtraPayment').value),
                            affectContributions:
    document.getElementById('vehicleAffectContributions').value === 'yes'
                        },
                        other: {
                            balance: parseFloat(document.getElementById('otherBalance').value),
                            rate: parseFloat(document.getElementById('otherRate').value) / 100,
                            payment: parseFloat(document.getElementById('otherPayment').value),
                            extraPayment:
    parseFloat(document.getElementById('otherExtraPayment').value),
                            affectContributions:
    document.getElementById('otherAffectContributions').value === 'yes'
                        }
                    }
                };

                const results = performCalculations(inputs);

                scenarios.push({
                    name: scenarioName,
                    inputs: inputs,
                    results: results,
                    color: scenarioColors[scenarios.length]
                });

                displayAllScenarios();

                // Clear scenario name for next input
                document.getElementById('scenarioName').value = '';
            }

            function clearScenarios() {
                scenarios = [];
                document.getElementById('results').style.display = 'none';
                document.getElementById('scenarioName').value = '';
            }

            function performCalculations(inputs) {
                const years = [];
                let portfolioValue = inputs.startingCapital;
                let fiAchieved = false;
                let fiYear = null;
                let fiAge = null;
                let currentYear = new Date().getFullYear();

                // Initialize debt tracking with months remaining
                let debtBalances = {
                    mortgage: inputs.debts.mortgage.balance,
                    vehicle: inputs.debts.vehicle.balance,
                    other: inputs.debts.other.balance
                };

                let debtMonths = {
                    mortgage: calculateMonthsRemaining(inputs.debts.mortgage.balance,
    inputs.debts.mortgage.rate, inputs.debts.mortgage.payment,
    inputs.debts.mortgage.extraPayment),
                    vehicle: calculateMonthsRemaining(inputs.debts.vehicle.balance,
    inputs.debts.vehicle.rate, inputs.debts.vehicle.payment,
    inputs.debts.vehicle.extraPayment),
                    other: calculateMonthsRemaining(inputs.debts.other.balance,
    inputs.debts.other.rate, inputs.debts.other.payment, inputs.debts.other.extraPayment)
                };

                for (let year = 0; year <= inputs.lifeExpectancy - inputs.currentAge; year++) {
                    const age = inputs.currentAge + year;
                    const actualYear = currentYear + year;

                    let baseSpending;
                    if (age <= inputs.activeUntilAge) {
                        baseSpending = inputs.activeSpending * Math.pow(1 +
    inputs.inflationRate, year);
                    } else {
                        baseSpending = inputs.inactiveSpending * Math.pow(1 +
    inputs.inflationRate, year);
                    }

                    // Calculate debt payments and remaining balances for this year
                    let totalDebtPayments = 0;
                    let debtPaymentsAffectingContributions = 0;
                    let totalRemainingDebt = 0;
                    const monthsElapsed = year * 12;

                    Object.keys(debtBalances).forEach(debtType => {
                        const debt = inputs.debts[debtType];
                        const originalMonths = debtMonths[debtType];

                        if (debtBalances[debtType] > 0 && monthsElapsed < originalMonths) {
                            // Still paying this debt
                            const totalMonthlyPayment = debt.payment + debt.extraPayment;
                            const annualPayment = totalMonthlyPayment * 12;

                            totalDebtPayments += annualPayment;

                            // Only count debt payments that affect contributions
                            if (debt.affectContributions) {
                                debtPaymentsAffectingContributions += annualPayment;
                            }

                            // Calculate remaining balance using amortization formula
                            if (debt.rate > 0) {
                                const monthlyRate = debt.rate / 12;
                                const remainingMonths = Math.max(0, originalMonths -
    monthsElapsed);
                                const currentBalance = totalMonthlyPayment * ((1 - Math.pow(1 +
     monthlyRate, -remainingMonths)) / monthlyRate);
                                debtBalances[debtType] = Math.max(0, currentBalance);
                            } else {
                                // Simple interest or no interest
                                debtBalances[debtType] = Math.max(0, debt.balance -
    (totalMonthlyPayment * monthsElapsed));
                            }
                        } else {
                            // Debt is paid off
                            debtBalances[debtType] = 0;
                        }

                        totalRemainingDebt += debtBalances[debtType];
                    });

                    // Total annual spending includes base spending plus debt payments
                    const annualSpending = baseSpending + totalDebtPayments;
                    const withdrawalCapacity = portfolioValue * inputs.withdrawalRate;

                    if (!fiAchieved && withdrawalCapacity >= annualSpending) {
                        fiAchieved = true;
                        fiYear = actualYear;
                        fiAge = age;
                    }

                    // Store current year's data before applying growth
                    const grossContributions = fiAchieved ? 0 : inputs.annualContributions;
                    const netContributions = grossContributions -
    debtPaymentsAffectingContributions;
                    const status = fiAchieved ? 'Financial Independence Achieved' : 'Building';

                    years.push({
                        year: actualYear,
                        age: age,
                        portfolioValue: portfolioValue,
                        annualSpending: annualSpending,
                        withdrawalCapacity: withdrawalCapacity,
                        contributions: netContributions,
                        totalRemainingDebt: totalRemainingDebt,
                        debtBreakdown: { ...debtBalances },
                        status: status,
                        isFiYear: !fiAchieved && withdrawalCapacity >= annualSpending
                    });

                    // Apply growth and changes for next year (except for the last iteration)
                    if (year < inputs.lifeExpectancy - inputs.currentAge) {
                        const growthReturn = portfolioValue * inputs.rateOfReturn;

                        if (fiAchieved) {
                            // After FI is achieved, subtract withdrawals from portfolio (which
     includes debt payments)
                            portfolioValue += growthReturn - withdrawalCapacity;
                        } else {
                            // Before FI, add net contributions (gross contributions minus debt
     payments)
                            portfolioValue += growthReturn + netContributions;
                        }
                    }
                }

                const finalPortfolioValue = portfolioValue;
                const monthlySavingsRequired = inputs.annualContributions / 12;

                return {
                    years: years,
                    fiYear: fiYear,
                    fiAge: fiAge,
                    finalPortfolioValue: finalPortfolioValue,
                    monthlySavingsRequired: monthlySavingsRequired
                };
            }

            function displayAllScenarios() {
                if (scenarios.length === 0) return;

                displayScenarioResults();
                createAllCharts();
                populateAllTables();

                document.getElementById('results').style.display = 'block';
            }

            function displayScenarioResults() {
                // Financial Independence Year
                let fiYearHTML = '';
                scenarios.forEach((scenario, index) => {
                    const fiText = scenario.results.fiYear ?
                        `${scenario.results.fiYear} (Age ${scenario.results.fiAge})` : 'Not 
    Achieved';
                    fiYearHTML += `<div class="scenario-result scenario-${index + 1}">
                        <strong>${scenario.name}:</strong> ${fiText}
                    </div>`;
                });
                document.getElementById('fiYear').innerHTML = fiYearHTML;

                // Final Portfolio Value
                let finalValueHTML = '';
                scenarios.forEach((scenario, index) => {
                    finalValueHTML += `<div class="scenario-result scenario-${index + 1}">
                        <strong>${scenario.name}:</strong> 
    ${formatCurrency(scenario.results.finalPortfolioValue)}
                    </div>`;
                });
                document.getElementById('finalValue').innerHTML = finalValueHTML;

                // Monthly Savings Required
                let monthlySavingsHTML = '';
                scenarios.forEach((scenario, index) => {
                    monthlySavingsHTML += `<div class="scenario-result scenario-${index + 1}">
                        <strong>${scenario.name}:</strong> 
    ${formatCurrency(scenario.results.monthlySavingsRequired)}
                    </div>`;
                });
                document.getElementById('monthlySavings').innerHTML = monthlySavingsHTML;
            }

            function createAllCharts() {
                createPortfolioChart();
                createSpendingChart();
                createDebtChart();
            }

            function createPortfolioChart() {
                const ctx = document.getElementById('portfolioChart').getContext('2d');

                if (portfolioChartInstance) {
                    portfolioChartInstance.destroy();
                }

                const datasets = [];
                let allAges = [];

                scenarios.forEach((scenario, index) => {
                    const ages = scenario.results.years.map(y => y.age);
                    const portfolioValues = scenario.results.years.map(y => y.portfolioValue);

                    if (index === 0) {
                        allAges = ages;
                    }

                    datasets.push({
                        label: scenario.name,
                        data: portfolioValues,
                        borderColor: scenario.color,
                        backgroundColor: scenario.color + '20',
                        fill: false,
                        tension: 0.1
                    });
                });

                portfolioChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: allAges,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Age'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Portfolio Value ($)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function createSpendingChart() {
                const ctx = document.getElementById('spendingChart').getContext('2d');

                if (spendingChartInstance) {
                    spendingChartInstance.destroy();
                }

                const datasets = [];
                let allAges = [];

                scenarios.forEach((scenario, index) => {
                    const ages = scenario.results.years.map(y => y.age);
                    const annualSpending = scenario.results.years.map(y => y.annualSpending);
                    const withdrawalCapacity = scenario.results.years.map(y =>
    y.withdrawalCapacity);

                    if (index === 0) {
                        allAges = ages;
                    }

                    datasets.push({
                        label: `${scenario.name} - Annual Spending`,
                        data: annualSpending,
                        borderColor: scenario.color,
                        backgroundColor: scenario.color + '20',
                        fill: false,
                        tension: 0.1,
                        borderDash: [5, 5]
                    });

                    datasets.push({
                        label: `${scenario.name} - Withdrawal Capacity`,
                        data: withdrawalCapacity,
                        borderColor: scenario.color,
                        backgroundColor: scenario.color + '20',
                        fill: false,
                        tension: 0.1
                    });
                });

                spendingChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: allAges,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Age'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Amount ($)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function createDebtChart() {
                // Check if any scenario has debt
                const hasDebt = scenarios.some(scenario =>
                    scenario.results.years.some(y => y.totalRemainingDebt > 0)
                );
                const debtSection = document.getElementById('debtChartSection');

                if (!hasDebt) {
                    debtSection.style.display = 'none';
                    return;
                }

                debtSection.style.display = 'block';
                const ctx = document.getElementById('debtChart').getContext('2d');

                if (debtChartInstance) {
                    debtChartInstance.destroy();
                }

                const datasets = [];
                let allAges = [];

                scenarios.forEach((scenario, index) => {
                    const ages = scenario.results.years.map(y => y.age);
                    const totalDebt = scenario.results.years.map(y => y.totalRemainingDebt);

                    if (index === 0) {
                        allAges = ages;
                    }

                    if (totalDebt.some(d => d > 0)) {
                        datasets.push({
                            label: `${scenario.name} - Total Debt`,
                            data: totalDebt,
                            borderColor: scenario.color,
                            backgroundColor: scenario.color + '20',
                            fill: false,
                            tension: 0.1
                        });
                    }
                });

                debtChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: allAges,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Age'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Remaining Debt ($)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function populateAllTables() {
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = '';

                if (scenarios.length === 0) return;

                // Get all unique years from all scenarios
                const allYears = [...new Set(scenarios.flatMap(s => s.results.years.map(y =>
    y.year)))].sort();

                allYears.forEach(year => {
                    scenarios.forEach((scenario, scenarioIndex) => {
                        const yearData = scenario.results.years.find(y => y.year === year);
                        if (!yearData) return;

                        const row = document.createElement('tr');
                        row.style.borderLeft = `4px solid ${scenario.color}`;
                        row.style.backgroundColor = scenario.color + '10';

                        if (yearData.status === 'Financial Independence Achieved' &&
                            scenario.results.years[scenario.results.years.indexOf(yearData) -
    1]?.status === 'Building') {
                            row.className = 'fi-row';
                        }

                        row.innerHTML = `
                            <td><strong>${scenario.name}</strong> ${yearData.year}</td>
                            <td>${yearData.age}</td>
                            <td>${formatCurrency(yearData.portfolioValue)}</td>
                            <td>${formatCurrency(yearData.annualSpending)}</td>
                            <td>${formatCurrency(yearData.withdrawalCapacity)}</td>
                            <td>${formatCurrency(yearData.contributions)}</td>
                            <td>${formatCurrency(yearData.totalRemainingDebt)}</td>
                            <td class="${yearData.status === 'Building' ? 'status-building' : 
    'status-fi'}">${yearData.status}</td>
                        `;

                        tableBody.appendChild(row);
                    });
                });
            }
        </script>
    </body>
    </html>
